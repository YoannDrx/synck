// Prisma Schema for Caroline Senyk Portfolio
// Database: Neon PostgreSQL
// Region: aws-eu-central-1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ASSET MANAGEMENT (Images)
// ============================================

model Asset {
  id           String   @id @default(cuid())
  path         String   @unique // Ex: /images/portfolio/work-slug/image.jpg
  alt          String?
  blurDataUrl  String?  @db.Text
  width        Int?
  height       Int?
  aspectRatio  Float?   // Calculated: width/height
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  workImages         Work[]         @relation("WorkImages")
  workCover          Work[]         @relation("WorkCover")
  categoryImages     Category[]     @relation("CategoryImages")
  labelImages        Label[]        @relation("LabelImages")
  composerImages     Composer[]     @relation("ComposerImages")
  blogPostImages     BlogPost[]     @relation("BlogPostImages")
  blogPostCover      BlogPost[]     @relation("BlogPostCover")
  expertiseImages    Expertise[]    @relation("ExpertiseImages")
  expertiseCover     Expertise[]    @relation("ExpertiseCover")

  @@index([path])
}

// ============================================
// CATEGORIES (Musique, Documentaire, etc.)
// ============================================

model Category {
  id          String   @id @default(cuid())
  slug        String   @unique
  color       String?  // Ex: "#FF6C2F"
  icon        String?  // Icon name or path
  coverImageId String?
  coverImage  Asset?   @relation("CategoryImages", fields: [coverImageId], references: [id])
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  translations CategoryTranslation[]
  works        Work[]

  @@index([slug])
  @@index([isActive, order])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId  String
  locale      String   // 'fr' or 'en'
  name        String   // Ex: "Musique", "Music"
  description String?  @db.Text

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
  @@index([locale])
}

// ============================================
// COMPOSERS / ARTISTS
// ============================================

model Composer {
  id           String   @id @default(cuid())
  slug         String   @unique
  imageId      String?
  image        Asset?   @relation("ComposerImages", fields: [imageId], references: [id])
  externalUrl  String?  // External link (YouTube, SoundCloud, etc.)
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  translations  ComposerTranslation[]
  contributions Contribution[]

  @@index([slug])
  @@index([isActive, order])
}

model ComposerTranslation {
  id         String  @id @default(cuid())
  composerId String
  locale     String  // 'fr' or 'en'
  name       String  // Ex: "Maurice Ravel", "Claude Debussy"
  bio        String? @db.Text

  composer Composer @relation(fields: [composerId], references: [id], onDelete: Cascade)

  @@unique([composerId, locale])
  @@index([locale])
}

// ============================================
// LABELS (Production companies, publishers)
// ============================================

model Label {
  id        String   @id @default(cuid())
  slug      String   @unique
  imageId   String?
  image     Asset?   @relation("LabelImages", fields: [imageId], references: [id])
  website   String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  translations LabelTranslation[]
  works        Work[]

  @@index([slug])
  @@index([isActive, order])
}

model LabelTranslation {
  id          String  @id @default(cuid())
  labelId     String
  locale      String  // 'fr' or 'en'
  name        String  // Ex: "Arte France", "INA"
  description String? @db.Text

  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([labelId, locale])
  @@index([locale])
}

// ============================================
// WORKS (Portfolio items)
// ============================================

model Work {
  id             String   @id @default(cuid())
  slug           String   @unique
  categoryId     String
  category       Category @relation(fields: [categoryId], references: [id])
  labelId        String?
  label          Label?   @relation(fields: [labelId], references: [id])
  coverImageId   String?
  coverImage     Asset?   @relation("WorkCover", fields: [coverImageId], references: [id])
  year           Int?
  duration       Int?     // In minutes
  status         String?  // Ex: "completed", "in-production"
  spotifyUrl     String?  // Spotify embed URL
  releaseDate    String?  // Release date (format: "YYYY-MM-DD" or "YYYY")
  genre          String?  // Musical genre (ex: "Trap / Hip Hop", "EDM")
  isrcCode       String?  // International Standard Recording Code
  order          Int      @default(0)
  isActive       Boolean  @default(true)
  isFeatured     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  translations  WorkTranslation[]
  contributions Contribution[]
  images        Asset[]           @relation("WorkImages")

  @@index([slug])
  @@index([categoryId, isActive, order])
  @@index([isFeatured, isActive])
}

model WorkTranslation {
  id          String  @id @default(cuid())
  workId      String
  locale      String  // 'fr' or 'en'
  title       String
  description String? @db.Text
  role        String? // Ex: "Gestionnaire des droits", "Rights Manager"

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, locale])
  @@index([locale])
}

// ============================================
// CONTRIBUTIONS (Many-to-Many: Work â†” Composer)
// ============================================

model Contribution {
  id         String   @id @default(cuid())
  workId     String
  work       Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  composerId String
  composer   Composer @relation(fields: [composerId], references: [id], onDelete: Cascade)
  role       String?  // Ex: "composer", "conductor", "performer"
  order      Int      @default(0)

  @@unique([workId, composerId])
  @@index([workId])
  @@index([composerId])
}

// ============================================
// BLOG POSTS
// ============================================

model BlogPost {
  id           String   @id @default(cuid())
  slug         String   @unique
  coverImageId String?
  coverImage   Asset?   @relation("BlogPostCover", fields: [coverImageId], references: [id])
  publishedAt  DateTime @default(now())
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  translations BlogPostTranslation[]
  tags         BlogPostTag[]
  images       Asset[]               @relation("BlogPostImages")

  @@index([slug])
  @@index([isPublished, publishedAt])
}

model BlogPostTranslation {
  id         String  @id @default(cuid())
  blogPostId String
  locale     String  // 'fr' or 'en'
  title      String
  excerpt    String? @db.Text
  content    String  @db.Text

  blogPost BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@unique([blogPostId, locale])
  @@index([locale])
}

model BlogPostTag {
  id         String   @id @default(cuid())
  blogPostId String
  tag        String
  locale     String   // 'fr' or 'en'

  blogPost BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@unique([blogPostId, tag, locale])
  @@index([tag, locale])
}

// ============================================
// EXPERTISES
// ============================================

model Expertise {
  id           String   @id @default(cuid())
  slug         String   @unique
  coverImageId String?
  coverImage   Asset?   @relation("ExpertiseCover", fields: [coverImageId], references: [id])
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  translations ExpertiseTranslation[]
  images       Asset[]                @relation("ExpertiseImages")

  @@index([slug])
  @@index([isActive, order])
}

model ExpertiseTranslation {
  id          String  @id @default(cuid())
  expertiseId String
  locale      String  // 'fr' or 'en'
  title       String
  subtitle    String?
  description String? @db.Text
  content     String  @db.Text

  expertise Expertise @relation(fields: [expertiseId], references: [id], onDelete: Cascade)

  @@unique([expertiseId, locale])
  @@index([locale])
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

enum UserRole {
  ADMIN   // Full access to admin panel
  VIEWER  // Read-only access (optional for future)
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String?
  image         String?   // Avatar URL
  role          UserRole  @default(ADMIN)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions        Session[]
  accounts        Account[]
  invitationsSent Invitation[] @relation("InvitationSender")

  @@index([email])
  @@index([role, isActive])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId    String    // Better Auth: account identifier
  providerId   String    // Better Auth: "credential", "google", etc.
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?   // Password hash for email/password auth
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model Invitation {
  id         String    @id @default(cuid())
  email      String
  token      String    @unique
  role       UserRole  @default(ADMIN)
  expiresAt  DateTime  // 7 days from creation
  acceptedAt DateTime?
  sentById   String
  sentBy     User      @relation("InvitationSender", fields: [sentById], references: [id])
  createdAt  DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}
