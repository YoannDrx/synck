// Prisma Schema for Caroline Senyk Projets
// Database: Neon PostgreSQL
// Region: aws-eu-central-1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ASSET MANAGEMENT (Images)
// ============================================

model Asset {
  id          String   @id @default(cuid())
  path        String   @unique // Ex: /images/projets/work-slug/image.jpg
  alt         String?
  blurDataUrl String?  @db.Text
  width       Int?
  height      Int?
  aspectRatio Float? // Calculated: width/height
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workImages      Work[]      @relation("WorkImages")
  workCover       Work[]      @relation("WorkCover")
  categoryImages  Category[]  @relation("CategoryImages")
  labelImages     Label[]     @relation("LabelImages")
  composerImages  Composer[]  @relation("ComposerImages")
  expertiseImages Expertise[] @relation("ExpertiseImages")
  expertiseCover  Expertise[] @relation("ExpertiseCover")
  cvPhotos        CV[]        @relation("CVPhoto")

  @@index([path])
}

// ============================================
// CATEGORIES (Musique, Documentaire, etc.)
// ============================================

model Category {
  id           String   @id @default(cuid())
  slug         String   @unique
  color        String? // Ex: "#FF6C2F"
  icon         String? // Icon name or path
  coverImageId String?
  coverImage   Asset?   @relation("CategoryImages", fields: [coverImageId], references: [id])
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  translations CategoryTranslation[]
  works        Work[]

  @@index([slug])
  @@index([isActive, order])
}

model CategoryTranslation {
  id          String  @id @default(cuid())
  categoryId  String
  locale      String // 'fr' or 'en'
  name        String // Ex: "Musique", "Music"
  description String? @db.Text

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
  @@index([locale])
}

// ============================================
// COMPOSERS / ARTISTS
// ============================================

model Composer {
  id          String   @id @default(cuid())
  slug        String   @unique
  imageId     String?
  image       Asset?   @relation("ComposerImages", fields: [imageId], references: [id])
  externalUrl String? // Primary external link (kept for backward compatibility)
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  translations  ComposerTranslation[]
  contributions Contribution[]
  links         ComposerLink[] // Multiple social/external links

  @@index([slug])
  @@index([isActive, order])
}

model ComposerTranslation {
  id         String  @id @default(cuid())
  composerId String
  locale     String // 'fr' or 'en'
  name       String // Ex: "Maurice Ravel", "Claude Debussy"
  bio        String? @db.Text

  composer Composer @relation(fields: [composerId], references: [id], onDelete: Cascade)

  @@unique([composerId, locale])
  @@index([locale])
}

model ComposerLink {
  id         String   @id @default(cuid())
  composerId String
  composer   Composer @relation(fields: [composerId], references: [id], onDelete: Cascade)
  platform   String // Ex: "youtube", "soundcloud", "spotify", "facebook", "instagram", "website"
  url        String
  label      String? // Display label (optional, ex: "Official YouTube Channel")
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  @@unique([composerId, url]) // Prevent duplicate URLs for same composer
  @@index([composerId])
  @@index([platform])
}

// ============================================
// LABELS (Production companies, publishers)
// ============================================

model Label {
  id        String   @id @default(cuid())
  slug      String   @unique
  imageId   String?
  image     Asset?   @relation("LabelImages", fields: [imageId], references: [id])
  website   String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  translations LabelTranslation[]
  works        Work[]

  @@index([slug])
  @@index([isActive, order])
}

model LabelTranslation {
  id          String  @id @default(cuid())
  labelId     String
  locale      String // 'fr' or 'en'
  name        String // Ex: "Arte France", "INA"
  description String? @db.Text

  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([labelId, locale])
  @@index([locale])
}

// ============================================
// WORKS (Projets)
// ============================================

model Work {
  id                     String   @id @default(cuid())
  slug                   String   @unique
  categoryId             String
  category               Category @relation(fields: [categoryId], references: [id])
  labelId                String?
  label                  Label?   @relation(fields: [labelId], references: [id])
  coverImageId           String?
  coverImage             Asset?   @relation("WorkCover", fields: [coverImageId], references: [id])
  year                   Int?
  productionCompanySlugs Json? // Array of production company slugs for documentaries (co-productions)
  status                 String? // Ex: "completed", "in-production"
  spotifyUrl             String? // Spotify embed URL
  youtubeUrl             String? // YouTube video URL (especially for synchros)
  externalUrl            String? // External link (website, IMDb, etc.)
  releaseDate            String? // Release date (format: "YYYY-MM-DD" or "YYYY")
  genre                  String? // Musical genre (ex: "Trap / Hip Hop", "EDM")
  order                  Int      @default(0)
  isActive               Boolean  @default(true)
  isFeatured             Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  translations  WorkTranslation[]
  contributions Contribution[]
  images        Asset[]           @relation("WorkImages")
  versions      WorkVersion[]
  previewTokens PreviewToken[]

  @@index([slug])
  @@index([categoryId, isActive, order])
  @@index([isFeatured, isActive])
}

model WorkTranslation {
  id          String  @id @default(cuid())
  workId      String
  locale      String // 'fr' or 'en'
  title       String
  subtitle    String? // Subtitle (ex: for synchros, the musical work title)
  description String? @db.Text
  role        String? // Ex: "Gestionnaire des droits", "Rights Manager"

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, locale])
  @@index([locale])
}

// ============================================
// CONTRIBUTIONS (Many-to-Many: Work ↔ Composer)
// ============================================

model Contribution {
  id         String   @id @default(cuid())
  workId     String
  work       Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  composerId String
  composer   Composer @relation(fields: [composerId], references: [id], onDelete: Cascade)
  role       String? // Ex: "composer", "conductor", "performer"
  order      Int      @default(0)

  @@unique([workId, composerId])
  @@index([workId])
  @@index([composerId])
}

// ============================================
// EXPERTISES
// ============================================

model Expertise {
  id           String   @id @default(cuid())
  slug         String   @unique
  coverImageId String?
  coverImage   Asset?   @relation("ExpertiseCover", fields: [coverImageId], references: [id])
  order        Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  translations ExpertiseTranslation[]
  images       Asset[]                @relation("ExpertiseImages")

  @@index([slug])
  @@index([isActive, order])
}

model ExpertiseTranslation {
  id          String  @id @default(cuid())
  expertiseId String
  locale      String // 'fr' or 'en'
  title       String
  subtitle    String?
  description String? @db.Text
  content     String  @db.Text

  expertise Expertise @relation(fields: [expertiseId], references: [id], onDelete: Cascade)

  @@unique([expertiseId, locale])
  @@index([locale])
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

enum UserRole {
  ADMIN // Full access to admin panel
  VIEWER // Read-only access (optional for future)
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  emailVerified    Boolean   @default(false)
  name             String?
  image            String? // Avatar URL
  role             UserRole  @default(ADMIN)
  isActive         Boolean   @default(true)
  twoFactorSecret  String? // TOTP secret for 2FA
  twoFactorEnabled Boolean   @default(false)
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  sessions        Session[]
  accounts        Account[]
  invitationsSent Invitation[]    @relation("InvitationSender")
  auditLogs       AuditLog[]
  workVersions    WorkVersion[]
  notifications   Notification[]
  exportHistory   ExportHistory[]

  @@index([email])
  @@index([role, isActive])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId      String // Better Auth: account identifier
  providerId     String // Better Auth: "credential", "google", etc.
  providerUserId String? // Provider-specific user ID (for OAuth providers)
  accessToken    String?   @db.Text
  refreshToken   String?   @db.Text
  idToken        String?   @db.Text
  expiresAt      DateTime?
  password       String? // Password hash for email/password auth
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model Invitation {
  id         String    @id @default(cuid())
  email      String
  token      String    @unique
  role       UserRole  @default(ADMIN)
  expiresAt  DateTime // 7 days from creation
  acceptedAt DateTime?
  sentById   String
  sentBy     User      @relation("InvitationSender", fields: [sentById], references: [id])
  createdAt  DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType String? // Work, Composer, etc.
  entityId   String?
  metadata   Json? // Détails changements
  ipAddress  String?
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// WORK VERSIONS (History)
// ============================================

model WorkVersion {
  id        String   @id @default(cuid())
  workId    String
  work      Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  snapshot  Json // Full work data
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([workId])
  @@index([createdAt])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // ASSET_ORPHANED, PROJECT_PUBLISHED, etc.
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  link      String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// PREVIEW TOKENS
// ============================================

model PreviewToken {
  id        String   @id @default(cuid())
  token     String   @unique
  workId    String
  work      Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

// ============================================
// EXPORT HISTORY
// ============================================

enum ExportType {
  ASSETS
  WORKS
  COMPOSERS
  CATEGORIES
  LABELS
  EXPERTISES
  ALL
}

enum ExportFormat {
  JSON
  CSV
  TXT
  XLS
}

enum ExportStatus {
  PENDING
  COMPLETED
  FAILED
}

model ExportHistory {
  id           String       @id @default(cuid())
  userId       String
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         ExportType
  format       ExportFormat
  entityCount  Int? // Nombre d'entités exportées
  fileSize     Int? // Taille du fichier en bytes
  status       ExportStatus @default(PENDING)
  errorMessage String?      @db.Text
  downloadUrl  String? // Optionnel: URL de téléchargement si stocké
  data         Json? // Données de l'export stockées en JSON
  createdAt    DateTime     @default(now())
  completedAt  DateTime?

  @@index([userId])
  @@index([createdAt])
  @@index([status])
}

// ============================================
// CV / RESUME
// ============================================

model CV {
  id       String  @id @default(cuid())
  isActive Boolean @default(true)

  // Personal info
  photoAssetId String?
  photoAsset   Asset?  @relation("CVPhoto", fields: [photoAssetId], references: [id])
  phone        String?
  email        String?
  website      String?
  location     String?
  linkedInUrl  String?

  // Bio/Headline (multilingue)
  headlineFr String? // Ex: "Gestionnaire de droits musicaux"
  headlineEn String? // Ex: "Music Rights Manager"
  bioFr      String? @db.Text
  bioEn      String? @db.Text

  // Layout settings
  layout      String  @default("creative") // classic, modern, creative, sidebar
  accentColor String  @default("#D5FF0A")
  showPhoto   Boolean @default(true)
  theme       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sections    CVSection[]
  skills      CVSkill[]
  socialLinks CVSocialLink[]

  @@map("cv")
}

model CVSection {
  id         String  @id @default(cuid())
  cvId       String
  cv         CV      @relation(fields: [cvId], references: [id], onDelete: Cascade)
  type       String // Ex: "experience", "education", "skills", "languages", "custom"
  icon       String? // Lucide icon name (ex: "Briefcase", "GraduationCap")
  color      String? // Hex color for section accent
  placement  String  @default("main") // "main", "sidebar"
  layoutType String  @default("list") // "list", "timeline", "grid"
  order      Int     @default(0)
  isActive   Boolean @default(true)

  translations CVSectionTranslation[]
  items        CVItem[]

  @@index([cvId])
  @@index([order])
  @@map("cv_section")
}

model CVSectionTranslation {
  id        String    @id @default(cuid())
  sectionId String
  section   CVSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  locale    String // 'fr' or 'en'
  title     String // Ex: "Expérience Professionnelle"

  @@unique([sectionId, locale])
  @@index([locale])
  @@map("cv_section_translation")
}

model CVItem {
  id        String    @id @default(cuid())
  sectionId String
  section   CVSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  startDate DateTime?
  endDate   DateTime?
  isCurrent Boolean   @default(false)
  order     Int       @default(0)
  isActive  Boolean   @default(true)

  translations CVItemTranslation[]

  @@index([sectionId])
  @@index([order])
  @@map("cv_item")
}

model CVItemTranslation {
  id          String  @id @default(cuid())
  itemId      String
  item        CVItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  locale      String // 'fr' or 'en'
  title       String // Ex: "Project Manager"
  subtitle    String? // Ex: "Company Name"
  location    String? // Ex: "Paris, France"
  description String? @db.Text

  @@unique([itemId, locale])
  @@index([locale])
  @@map("cv_item_translation")
}

model CVSkill {
  id        String  @id @default(cuid())
  cvId      String
  cv        CV      @relation(fields: [cvId], references: [id], onDelete: Cascade)
  category  String // "technical", "soft", "language", "software"
  level     Int     @default(3) // 1-5 or 0-100
  showAsBar Boolean @default(true)
  order     Int     @default(0)
  isActive  Boolean @default(true)

  translations CVSkillTranslation[]

  @@index([cvId])
  @@index([category])
  @@map("cv_skill")
}

model CVSkillTranslation {
  id      String  @id @default(cuid())
  skillId String
  skill   CVSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  locale  String // 'fr' or 'en'
  name    String // Ex: "Gestion de droits", "Copyright Management"

  @@unique([skillId, locale])
  @@index([locale])
  @@map("cv_skill_translation")
}

model CVSocialLink {
  id       String  @id @default(cuid())
  cvId     String
  cv       CV      @relation(fields: [cvId], references: [id], onDelete: Cascade)
  platform String // "linkedin", "github", "website", "email", "phone"
  url      String
  label    String? // Custom label (optional)
  order    Int     @default(0)

  @@index([cvId])
  @@map("cv_social_link")
}
